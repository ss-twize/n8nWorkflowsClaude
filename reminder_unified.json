{
  "name": "Reminder Unified ‚Äî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–ø–∏—Å—è—Ö (–≤—Å–µ –∫–∞–Ω–∞–ª—ã)",
  "nodes": [
    {
      "id": "e001-0000-0000-0000-000000000001",
      "name": "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000002",
      "name": "GET –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [240, 300],
      "parameters": {
        "method": "GET",
        "url": "={{ 'https://ugocvtuomyopullvilim.supabase.co/rest/v1/appointments?reminder_24h=is.null&status=neq.cancelled&date=gte.' + $now.plus({days:1}).startOf('day').toISO() + '&date=lte.' + $now.plus({days:1}).endOf('day').toISO() + '&select=record_id,date,tg_id,wa_id,max_id,phone,YC_ID,client_id,clientName,service_name,master_name' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000003",
      "name": "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300],
      "parameters": {
        "jsCode": "const body = $input.first().json;\nif (!Array.isArray(body) || body.length === 0) return [];\nreturn body.map(item => ({ json: item }));"
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000004",
      "name": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [720, 300],
      "parameters": { "options": {} }
    },
    {
      "id": "e001-0000-0000-0000-000000000005",
      "name": "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [960, 200],
      "parameters": {
        "method": "GET",
        "url": "={{ 'https://ugocvtuomyopullvilim.supabase.co/rest/v1/clients_tg?tg_id=eq.' + $json.tg_id + '&select=tg_id,first_name,last_name,blocked,can_message' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000006",
      "name": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 200],
      "parameters": {
        "jsCode": "const appt = $('–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏').item.json;\nconst clientRaw = $input.first().json;\nconst client = Array.isArray(clientRaw) && clientRaw.length > 0 ? clientRaw[0] : {};\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã\nconst dt = new Date(appt.date);\nconst dateFormatted = dt.toLocaleDateString('ru-RU', {\n  weekday: 'long', day: 'numeric', month: 'long', timeZone: 'Europe/Moscow'\n}) + ' –≤ ' + dt.toLocaleTimeString('ru-RU', {\n  hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Moscow'\n});\n\n// –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞\nconst clientName = client.first_name\n  ? (client.first_name + (client.last_name ? ' ' + client.last_name : ''))\n  : (appt.clientName || '–ö–ª–∏–µ–Ω—Ç');\n\n// –¢–µ–∫—Å—Ç –¥–ª—è rich-–∫–∞–Ω–∞–ª–æ–≤ (TG, WA, Max)\nconst richText = `üìÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏\\n\\n–ü—Ä–∏–≤–µ—Ç, ${clientName}! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –≤–∞—à–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Å–∞–ª–æ–Ω–µ –∫—Ä–∞—Å–æ—Ç—ã –ü—è—Ç—å —Ä—É—á–µ–∫:\\n\\nüóì –î–∞—Ç–∞: ${dateFormatted}\\n‚úÇÔ∏è –£—Å–ª—É–≥–∞: ${appt.service_name || ''}\\nüë§ –ú–∞—Å—Ç–µ—Ä: ${appt.master_name || ''}\\n\\n–ñ–¥—ë–º –≤–∞—Å!`;\n\n// –¢–µ–∫—Å—Ç –¥–ª—è SMS (–±–µ–∑ —ç–º–æ–¥–∑–∏, –∫–æ—Ä–æ—á–µ)\nconst smsText = `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º: –∑–∞–≤—Ç—Ä–∞ ${dateFormatted} –≤ —Å–∞–ª–æ–Ω–µ –ü—è—Ç—å —Ä—É—á–µ–∫. –£—Å–ª—É–≥–∞: ${appt.service_name || ''}. –ú–∞—Å—Ç–µ—Ä: ${appt.master_name || ''}. –ñ–¥—ë–º –≤–∞—Å!`;\n\n// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É: TG ‚Üí Max ‚Üí WA ‚Üí SMS\nconst tgOk = appt.tg_id && client.can_message !== 'false' && client.blocked !== 'true';\nconst maxOk = appt.max_id;\nconst waOk  = appt.wa_id;\nconst smsOk = appt.phone;\n\nlet channel = 'none';\nif (tgOk)       channel = 'telegram';\nelse if (maxOk) channel = 'max';\nelse if (waOk)  channel = 'whatsapp';\nelse if (smsOk) channel = 'sms';\n\n// –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å\nif (channel === 'none') return [];\n\nreturn [{\n  json: {\n    record_id:     appt.record_id,\n    channel:       channel,\n    tg_id:         String(appt.tg_id || ''),\n    wa_id:         String(appt.wa_id || ''),\n    max_id:        String(appt.max_id || ''),\n    phone:         String(appt.phone || ''),\n    service_name:  appt.service_name || '',\n    master_name:   appt.master_name  || '',\n    client_name:   clientName,\n    date_formatted: dateFormatted,\n    rich_text:     richText,\n    sms_text:      smsText\n  }\n}];"
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000007",
      "name": "Switch: –∫–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [1440, 200],
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.channel }}",
        "rules": {
          "rules": [
            { "value2": "telegram",  "output": 0 },
            { "value2": "max",       "output": 1 },
            { "value2": "whatsapp",  "output": 2 },
            { "value2": "sms",       "output": 3 }
          ]
        },
        "fallbackOutput": "none"
      }
    },

    {
      "id": "e001-0000-0000-0000-000000000008",
      "name": "[TG] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1680, -20],
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "={{ $json.rich_text }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "56b5PgNwe1YoXmQn",
          "name": "test"
        }
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000009",
      "name": "[TG] Supabase: reminder_24h = sent_tg",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1920, -20],
      "parameters": {
        "operation": "update",
        "tableId": "appointments",
        "filterType": "string",
        "filterString": "={{ 'record_id=eq.' + $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª').item.json.record_id }}",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "reminder_24h", "fieldValue": "sent_tg" }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "id": "YOUR_SUPABASE_CRED_ID",
          "name": "Supabase"
        }
      }
    },

    {
      "id": "e001-0000-0000-0000-000000000010",
      "name": "[Max] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1680, 160],
      "parameters": {
        "method": "POST",
        "url": "–ó–ê–ú–ï–ù–ò_–ù–ê_MAX_WEBHOOK_URL",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer –ó–ê–ú–ï–ù–ò_–ù–ê_MAX_TOKEN"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "chat_id", "value": "={{ $json.max_id }}" },
            { "name": "text",    "value": "={{ $json.rich_text }}" }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000011",
      "name": "[Max] Supabase: reminder_24h = sent_max",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1920, 160],
      "parameters": {
        "operation": "update",
        "tableId": "appointments",
        "filterType": "string",
        "filterString": "={{ 'record_id=eq.' + $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª').item.json.record_id }}",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "reminder_24h", "fieldValue": "sent_max" }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "id": "YOUR_SUPABASE_CRED_ID",
          "name": "Supabase"
        }
      }
    },

    {
      "id": "e001-0000-0000-0000-000000000012",
      "name": "[WA] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1680, 340],
      "parameters": {
        "method": "POST",
        "url": "https://api.wazzup24.com/v3/message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer e729722567ce42199e74f4cc8e6acf4a"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "channelId", "value": "–ó–ê–ú–ï–ù–ò_–ù–ê_WAZZUP_CHANNEL_ID" },
            { "name": "chatType",  "value": "whatsapp" },
            { "name": "chatId",    "value": "={{ $json.wa_id }}" },
            { "name": "text",      "value": "={{ $json.rich_text }}" }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000013",
      "name": "[WA] Supabase: reminder_24h = sent_wa",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1920, 340],
      "parameters": {
        "operation": "update",
        "tableId": "appointments",
        "filterType": "string",
        "filterString": "={{ 'record_id=eq.' + $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª').item.json.record_id }}",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "reminder_24h", "fieldValue": "sent_wa" }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "id": "YOUR_SUPABASE_CRED_ID",
          "name": "Supabase"
        }
      }
    },

    {
      "id": "e001-0000-0000-0000-000000000014",
      "name": "[SMS] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.sms77",
      "typeVersion": 1,
      "position": [1680, 520],
      "parameters": {
        "to": "={{ $json.phone }}",
        "message": "={{ $json.sms_text }}",
        "options": {}
      },
      "credentials": {
        "sms77Api": {
          "id": "UbHSQrpL2EN5yzQn",
          "name": "seven account"
        }
      }
    },
    {
      "id": "e001-0000-0000-0000-000000000015",
      "name": "[SMS] Supabase: reminder_24h = sent_sms",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1920, 520],
      "parameters": {
        "operation": "update",
        "tableId": "appointments",
        "filterType": "string",
        "filterString": "={{ 'record_id=eq.' + $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª').item.json.record_id }}",
        "fieldsUi": {
          "fieldValues": [
            { "fieldId": "reminder_24h", "fieldValue": "sent_sms" }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "id": "YOUR_SUPABASE_CRED_ID",
          "name": "Supabase"
        }
      }
    }
  ],
  "connections": {
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00": {
      "main": [[{ "node": "GET –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞", "type": "main", "index": 0 }]]
    },
    "GET –∑–∞–ø–∏—Å–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞": {
      "main": [[{ "node": "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π", "type": "main", "index": 0 }]]
    },
    "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    },
    "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏": {
      "main": [
        [{ "node": "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id", "type": "main", "index": 0 }],
        []
      ]
    },
    "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id": {
      "main": [[{ "node": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª", "type": "main", "index": 0 }]]
    },
    "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å + –≤—ã–±—Ä–∞—Ç—å –∫–∞–Ω–∞–ª": {
      "main": [[{ "node": "Switch: –∫–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏", "type": "main", "index": 0 }]]
    },
    "Switch: –∫–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏": {
      "main": [
        [{ "node": "[TG] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",  "type": "main", "index": 0 }],
        [{ "node": "[Max] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "type": "main", "index": 0 }],
        [{ "node": "[WA] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ",  "type": "main", "index": 0 }],
        [{ "node": "[SMS] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "type": "main", "index": 0 }]
      ]
    },
    "[TG] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ": {
      "main": [[{ "node": "[TG] Supabase: reminder_24h = sent_tg", "type": "main", "index": 0 }]]
    },
    "[TG] Supabase: reminder_24h = sent_tg": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    },
    "[Max] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ": {
      "main": [[{ "node": "[Max] Supabase: reminder_24h = sent_max", "type": "main", "index": 0 }]]
    },
    "[Max] Supabase: reminder_24h = sent_max": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    },
    "[WA] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ": {
      "main": [[{ "node": "[WA] Supabase: reminder_24h = sent_wa", "type": "main", "index": 0 }]]
    },
    "[WA] Supabase: reminder_24h = sent_wa": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    },
    "[SMS] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ": {
      "main": [[{ "node": "[SMS] Supabase: reminder_24h = sent_sms", "type": "main", "index": 0 }]]
    },
    "[SMS] Supabase: reminder_24h = sent_sms": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "448605b2d85039fda3236eb2e96b6b266eec110c39c8f8814847e4541b63dac6"
  }
}
