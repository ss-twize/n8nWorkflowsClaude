{
  "name": "TG Reminder - –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏",
  "nodes": [
    {
      "id": "c001-0000-0000-0000-000000000001",
      "name": "–ö–∞–∂–¥—ã–π —á–∞—Å",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300],
      "parameters": {
        "rule": {
          "interval": [{ "field": "hours", "minutesInterval": 1 }]
        }
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000002",
      "name": "GET appointments",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [240, 300],
      "parameters": {
        "method": "GET",
        "url": "={{ 'https://ugocvtuomyopullvilim.supabase.co/rest/v1/appointments?reminder_24h=is.null&tg_id=not.is.null&date=gte.' + $now.toISO() + '&date=lte.' + $now.plus({hours: 25}).toISO() + '&select=record_id,date,tg_id,YC_ID,client_id,clientName,service_name,master_name,status' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000003",
      "name": "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300],
      "parameters": {
        "jsCode": "const body = $input.first().json;\n// –ï—Å–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ ‚Äî workflow –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è\nif (!Array.isArray(body) || body.length === 0) {\n  return [];\n}\nreturn body.map(item => ({ json: item }));"
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000004",
      "name": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [720, 300],
      "parameters": { "options": {} }
    },
    {
      "id": "c001-0000-0000-0000-000000000005",
      "name": "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [960, 200],
      "parameters": {
        "method": "GET",
        "url": "={{ 'https://ugocvtuomyopullvilim.supabase.co/rest/v1/clients_tg?tg_id=eq.' + $json.tg_id + '&select=tg_id,first_name,last_name,tg_username,blocked,can_message' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000006",
      "name": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å + –∫–ª–∏–µ–Ω—Ç",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 200],
      "parameters": {
        "jsCode": "// –ë–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –∏–∑ SplitInBatches\nconst appt = $('–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏').item.json;\n\n// –ë–µ—Ä—ë–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ HTTP –∑–∞–ø—Ä–æ—Å–∞\nconst clientBody = $input.first().json;\nconst client = Array.isArray(clientBody) && clientBody.length > 0 ? clientBody[0] : null;\n\n// –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º\nif (!client) return [];\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\nif (client.blocked === 'true' || client.blocked === true) return [];\nif (client.can_message === 'false' || client.can_message === false) return [];\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º\nconst dt = new Date(appt.date);\nconst dateFormatted = dt.toLocaleDateString('ru-RU', {\n  day: 'numeric',\n  month: 'long',\n  timeZone: 'Europe/Moscow'\n}) + ' –≤ ' + dt.toLocaleTimeString('ru-RU', {\n  hour: '2-digit',\n  minute: '2-digit',\n  timeZone: 'Europe/Moscow'\n});\n\n// –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: –∏–∑ clients_tg –∏–ª–∏ –∏–∑ appointments\nconst clientName = client.first_name\n  ? (client.first_name + (client.last_name ? ' ' + client.last_name : ''))\n  : (appt.clientName || '–ö–ª–∏–µ–Ω—Ç');\n\nreturn [{\n  json: {\n    record_id:     appt.record_id,\n    tg_id:         appt.tg_id,\n    YC_ID:         appt.YC_ID,\n    client_id:     appt.client_id,\n    client_name:   clientName,\n    tg_username:   client.tg_username || '',\n    service_name:  appt.service_name || '',\n    master_name:   appt.master_name  || '',\n    date_raw:      appt.date,\n    date_formatted: dateFormatted\n  }\n}];"
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000007",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1440, 200],
      "parameters": {
        "chatId": "={{ $json.tg_id }}",
        "text": "=üìÖ *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏*\n\n–ü—Ä–∏–≤–µ—Ç, {{ $json.client_name }}! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –≤–∞—à–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Å–∞–ª–æ–Ω *–ü—è—Ç—å —Ä—É—á–µ–∫*:\n\nüóì *–î–∞—Ç–∞:* {{ $json.date_formatted }}\n‚úÇÔ∏è *–£—Å–ª—É–≥–∞:* {{ $json.service_name }}\nüë§ *–ú–∞—Å—Ç–µ—Ä:* {{ $json.master_name }}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à –≤–∏–∑–∏—Ç:",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown",
          "replyMarkup": "inlineKeyboard",
          "inlineKeyboard": {
            "rows": [
              {
                "row": {
                  "buttons": [
                    {
                      "text": "‚úÖ –ü—Ä–∏–¥—É",
                      "callbackData": "=confirm_{{ $json.record_id }}"
                    }
                  ]
                }
              },
              {
                "row": {
                  "buttons": [
                    {
                      "text": "üîÑ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏",
                      "callbackData": "=reschedule_{{ $json.record_id }}"
                    }
                  ]
                }
              },
              {
                "row": {
                  "buttons": [
                    {
                      "text": "‚ùå –ù–µ —Å–º–æ–≥—É",
                      "callbackData": "=cancel_{{ $json.record_id }}"
                    }
                  ]
                }
              }
            ]
          }
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "56b5PgNwe1YoXmQn",
          "name": "test"
        }
      }
    },
    {
      "id": "c001-0000-0000-0000-000000000008",
      "name": "PATCH appointment ‚Äî reminder –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1680, 200],
      "parameters": {
        "method": "PATCH",
        "url": "={{ 'https://ugocvtuomyopullvilim.supabase.co/rest/v1/appointments?record_id=eq.' + $('–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å + –∫–ª–∏–µ–Ω—Ç').item.json.record_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2N2dHVvbXlvcHVsbHZpbGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTcxMjIsImV4cCI6MjA4NzY3MzEyMn0.rx7-A9_-WYWGRgZhDRwvLU3Roqds14Tv-DUqL9NJXrk"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ reminder_24h: 'sent', tg_reminder_msg_id: $('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏').item.json.result.message_id }) }}",
        "options": {}
      }
    }
  ],
  "connections": {
    "–ö–∞–∂–¥—ã–π —á–∞—Å": {
      "main": [[{ "node": "GET appointments", "type": "main", "index": 0 }]]
    },
    "GET appointments": {
      "main": [[{ "node": "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π", "type": "main", "index": 0 }]]
    },
    "–†–∞–∑–æ–±—Ä–∞—Ç—å –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    },
    "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏": {
      "main": [
        [{ "node": "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id", "type": "main", "index": 0 }],
        []
      ]
    },
    "GET –∫–ª–∏–µ–Ω—Ç –ø–æ tg_id": {
      "main": [[{ "node": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å + –∫–ª–∏–µ–Ω—Ç", "type": "main", "index": 0 }]]
    },
    "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å + –∫–ª–∏–µ–Ω—Ç": {
      "main": [[{ "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏", "type": "main", "index": 0 }]]
    },
    "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏": {
      "main": [[{ "node": "PATCH appointment ‚Äî reminder –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", "type": "main", "index": 0 }]]
    },
    "PATCH appointment ‚Äî reminder –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω": {
      "main": [[{ "node": "–ü–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏", "type": "main", "index": 0 }]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "448605b2d85039fda3236eb2e96b6b266eec110c39c8f8814847e4541b63dac6"
  }
}
